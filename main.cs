using Mutagen.Bethesda;
using Mutagen.Bethesda.Skyrim;
using Mutagen.Bethesda.Synthesis;
using System.Text.Json.Nodes;

namespace ReProccer;
static class Executor
{
    internal static IPatcherState<ISkyrimMod, ISkyrimModGetter>? State;

    internal static Lazy<Config.SettingsUI> SettingsUI = new();
    internal static readonly Lazy<Config.General> General = new();

    // entry point
    public static async Task<int> Main(string[] args)
    {
        return await SynthesisPipeline.Instance
        .AddPatch<ISkyrimMod, ISkyrimModGetter>(Initialize)
        .SetAutogeneratedSettings("ReProccer Evolved", "settings/settings.json", out SettingsUI)
        .SetTypicalOpen(GameRelease.SkyrimSE, "ReProccer.esp")
        .Run(args);
    }

    // init process
    public static void Initialize(IPatcherState<ISkyrimMod, ISkyrimModGetter> patcherState)
    {
        Console.WriteLine("");

        // getting state
        State = patcherState;
		
        // loading strings	
        JsonNode stringsJson = Utils.Helpers.LoadJson($"{AppContext.BaseDirectory}locales", "english.jsonc", true);

        string[] jsonFiles = [.. Directory.GetFiles($"{AppContext.BaseDirectory}locales", "*.json*")
        .Where(name => !name.Contains("english.jsonc"))
        .Select(file => Path.GetFileName(file))];

        if (jsonFiles.Length > 0)
        {
            foreach (var file in jsonFiles)
            {
                JsonNode locStrings = Utils.Helpers.LoadJson($"{AppContext.BaseDirectory}locales", file);
                stringsJson = Utils.Helpers.DeepMerge(stringsJson, locStrings);
            }
        }

        Strings = stringsJson!.AsObject();

        // building rules
        var loadOrder = State.LoadOrder;

        if (!loadOrder.Any(file => file.Key.FileName.Equals("Skyrim AE Redone - Core.esm")))
        {
            throw new Exception("\n--> Skyrim AE Redone - Core.esm should be active in the load order!\n");
        }

        if (!loadOrder.Any(file => file.Key.FileName.Equals("Skyrim AE Redone - Main.esp")))
        {
            throw new Exception("\n--> The patching is only required if the Main Module is installed\n");
        }

        JsonNode rulesJson = Utils.Helpers.LoadJson($"{AppContext.BaseDirectory}rules", "_rules-basic.jsonc");

        foreach (var file in loadOrder)
        {
            if (!file.Value.Enabled || General.Value.IgnoredFiles!.Any(name => name == file.Key.FileName)) continue;

            string[] match = Directory.GetFiles($"{AppContext.BaseDirectory}rules", $"{file.Key.Name}.json*");
            if (match.Length == 0) continue;

            JsonNode pluginRules = Utils.Helpers.LoadJson($"{AppContext.BaseDirectory}rules", $"{Path.GetFileName(match[0])}", true);
            rulesJson = Utils.Helpers.DeepMerge(rulesJson, pluginRules);
        }

        JsonNode userRules = Utils.Helpers.LoadJson($"{AppContext.BaseDirectory}rules", "_rules-user.jsonc", true);
        rulesJson = Utils.Helpers.DeepMerge(rulesJson, userRules);
        Rules = rulesJson!.AsObject();
    }
}